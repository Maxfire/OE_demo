# ==============================================================================
# Pull request clone ===========================================================
# ==============================================================================
# Use plugin to checkout pull requests for caching issue:
# https://github.com/drone/drone/issues/2390
# ==============================================================================
clone:
  git:
    image: registry.fpfis.eu/drone-plugins/git:next

# ==============================================================================
# Workspace location.
# ==============================================================================
workspace:
  base: /test
  path: toolkit

# ==============================================================================
# Matrix section
# ==============================================================================
matrix:
  include:
    - DRUPAL: 7.x-dev
      TK: 3.3.4
      ID: TK3D7
      COMMAND: toolkit/phing
      COMPOSER: 1
    - DRUPAL: 8.x-dev
      TK: 4.4.6
      ID: TK4D8
      COMMAND: vendor/bin/run
      COMPOSER: 1
    - DRUPAL: 9.x-dev
      TK: 8.2.2
      ID: TK8D9
      COMMAND: vendor/bin/run
      COMPOSER: 2

# ==============================================================================
# Main services
# ==============================================================================
services:
  mysql:
    image: registry.fpfis.eu/fpfis/sql:percona-${MYSQL_VERSION=5.7}
    command: --innodb-log-file_size=128M --max-allowed-packet=1G --innodb-buffer-pool-size=512M
    environment:
      - MYSQL_ALLOW_EMPTY_PASSWORD=yes

# ==============================================================================
# Pipelines
# ==============================================================================
pipeline:

  # ============================================================================
  # Prepare section:
  # ============================================================================
  grab-site:
    image: registry.fpfis.eu/fpfis/httpd-php:${PHP_VERSION=7.3}-ci
    group: prepare
    commands:
      - git remote -v
      - echo PROJECT=$(pwd)
      - rm -rf /test/toolkit/*
      - rm -rf .drone.yml
      - rm -rf .gitignore
      - rm -rf .git
      - rm -rf .env
      # - git init
      # - git remote add ${ID} https://github.com/ec-europa/subsite
      # - git fetch ${ID}
      # - git checkout -b ${BRANCH} --track ${ID}/${BRANCH} # origin/master is clone's default
    volumes:
      - /cache/${DRONE_REPO_NAME}/${ID}:/cache

  # ============================================================================
  # Setup section:
  # ============================================================================
  toolkit:
    image: registry.fpfis.eu/fpfis/httpd-php:${PHP_VERSION=7.3}-ci
    group: setup
    secrets: [ github_api_token ]
    commands:
      - ls -lah
      - composer self-update --${COMPOSER}
      - composer create-project drupal-composer/drupal-project:${DRUPAL} ${ID} --no-interaction
      - ls -lah
      - composer require -w --working-dir=$ID --dev ec-europa/toolkit:${TK}
    volumes:
      - /cache/${DRONE_REPO_NAME}/${ID}:/cache

  # ============================================================================
  # Build section:
  # ============================================================================
  install:
    image: registry.fpfis.eu/fpfis/httpd-php:${PHP_VERSION=7.3}-ci
    group: build
    secrets: [ github_api_token ]
    commands:
      - ${COMMAND}
    volumes:
      - /cache/${DRONE_REPO_NAME}/${ID}:/cache

